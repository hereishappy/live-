<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Site Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1rem;
        }

        .header {
            text-align: center;
            margin-bottom: 2rem;
            color: white;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .nav-tabs {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .tab-button {
            padding: 12px 24px;
            background: rgba(255,255,255,0.2);
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 25px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            font-weight: 600;
        }

        .tab-button.active {
            background: rgba(255,255,255,0.9);
            color: #333;
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        .section-header {
            background: rgba(255,255,255,0.95);
            padding: 1.5rem;
            border-radius: 15px;
            margin-bottom: 2rem;
            text-align: center;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
        }

        .section-header h2 {
            color: #2c3e50;
            font-size: 1.8rem;
            margin-bottom: 0.5rem;
        }

        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .card {
            background: rgba(255,255,255,0.95);
            border-radius: 20px;
            padding: 1.5rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.15);
        }

        .card-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .metric {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.8rem;
            padding: 0.5rem;
            background: rgba(74, 144, 226, 0.1);
            border-radius: 10px;
        }

        .metric-label {
            font-weight: 600;
            color: #34495e;
        }

        .metric-value {
            font-weight: 700;
            color: #2980b9;
            font-size: 1.1rem;
        }

        .ai-suggestion {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 1rem;
            border-radius: 12px;
            margin-top: 1rem;
            font-size: 0.9rem;
            line-height: 1.5;
        }

        .ai-suggestion::before {
            content: "ü§ñ AI Suggestion: ";
            font-weight: 700;
        }

        .calendar {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
            margin-top: 1rem;
        }

        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            font-size: 0.8rem;
            font-weight: 600;
            position: relative;
        }

        .calendar-header {
            background: #34495e;
            color: white;
            font-weight: 700;
        }

        .calendar-date {
            background: #ecf0f1;
            color: #7f8c8d;
        }

        .present {
            background: #2ecc71;
            color: white;
        }

        .absent {
            background: #e74c3c;
            color: white;
        }

        .overtime {
            background: #f39c12;
            color: white;
        }

        .overtime::after {
            content: "OT";
            position: absolute;
            top: -2px;
            right: -2px;
            font-size: 0.6rem;
            background: #e67e22;
            padding: 1px 3px;
            border-radius: 3px;
        }

        .status-legend {
            display: flex;
            justify-content: space-around;
            margin-top: 1rem;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.8rem;
        }

        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .overall-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: rgba(255,255,255,0.9);
            padding: 1.5rem;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }

        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            color: #2980b9;
        }

        .stat-label {
            font-size: 0.9rem;
            color: #7f8c8d;
            margin-top: 0.5rem;
        }

        @media (max-width: 768px) {
            .container {
                padding: 0.5rem;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .nav-tabs {
                flex-direction: column;
                align-items: center;
            }
            
            .cards-grid {
                grid-template-columns: 1fr;
            }
            
            .overall-stats {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .calendar {
                gap: 2px;
            }
            
            .calendar-day {
                font-size: 0.7rem;
            }
        }

        .loading {
            text-align: center;
            color: white;
            font-size: 1.2rem;
            padding: 2rem;
        }

        .error {
            background: #e74c3c;
            color: white;
            padding: 1rem;
            border-radius: 10px;
            margin: 1rem 0;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä Site Dashboard</h1>
            <p>Real-time Performance & Attendance Analytics</p>
        </div>

        <div class="nav-tabs">
            <button class="tab-button active" onclick="showPage('performance')">üìà Performance</button>
            <button class="tab-button" onclick="showPage('attendance')">üìÖ Attendance</button>
        </div>

        <!-- Performance Page -->
        <div id="performance" class="page active">
            <div class="section-header">
                <h2>üéØ Overall Site Performance</h2>
                <p>Comprehensive site analytics and AI-powered insights</p>
            </div>

            <div id="overall-stats" class="overall-stats">
                <!-- Overall stats will be populated here -->
            </div>

            <div id="site-ai-suggestion" class="card">
                <div class="ai-suggestion">
                    Analyzing site performance data to generate intelligent recommendations...
                </div>
            </div>

            <div id="performance-cards" class="cards-grid">
                <!-- Performance cards will be populated here -->
            </div>
        </div>

        <!-- Attendance Page -->
        <div id="attendance" class="page">
            <div class="section-header">
                <h2>üìÖ Site Performance and AI Suggestions</h2>
                <p>Worker attendance tracking with smart analytics</p>
            </div>

            <div id="attendance-ai-suggestion" class="card">
                <div class="ai-suggestion">
                    Analyzing attendance patterns to provide workforce optimization insights...
                </div>
            </div>

            <div id="attendance-cards" class="cards-grid">
                <!-- Attendance cards will be populated here -->
            </div>
        </div>
    </div>

    <script>
        // Your actual CSV URLs
        const PERFORMANCE_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTRmYg3zmYTdR76pDZirRk3Q-jGChOHtKwW5sRhi9NmaOWjCCvMeGi_CzmtbEVRrVt_u4mgTQmyrjYB/pub?gid=1486071949&single=true&output=csv';
        const ATTENDANCE_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTRmYg3zmYTdR76pDZirRk3Q-jGChOHtKwW5sRhi9NmaOWjCCvMeGi_CzmtbEVRrVt_u4mgTQmyrjYB/pub?gid=1025965600&single=true&output=csv';

        // Sample data for demonstration (remove this when using real CSVs)
        const samplePerformanceData = [
            { supervisor: 'John Smith', productivity_rate: 85, tasks_completed: 120, efficiency_score: 92, target_achievement: 88 },
            { supervisor: 'Sarah Johnson', productivity_rate: 91, tasks_completed: 156, efficiency_score: 89, target_achievement: 95 },
            { supervisor: 'Mike Chen', productivity_rate: 78, tasks_completed: 98, efficiency_score: 85, target_achievement: 82 },
            { supervisor: 'Lisa Brown', productivity_rate: 94, tasks_completed: 178, efficiency_score: 96, target_achievement: 97 }
        ];

        const sampleAttendanceData = [
            { worker: 'Alice Williams', date: '2025-08-01', hours_worked: 8 },
            { worker: 'Bob Davis', date: '2025-08-01', hours_worked: 9.5 },
            { worker: 'Carol Miller', date: '2025-08-01', hours_worked: 8 },
            { worker: 'Alice Williams', date: '2025-08-02', hours_worked: 7.5 },
            { worker: 'Bob Davis', date: '2025-08-02', hours_worked: 8 },
            { worker: 'David Wilson', date: '2025-08-03', hours_worked: 10 },
            { worker: 'Alice Williams', date: '2025-08-05', hours_worked: 8.5 }
        ];

        let performanceData = [];
        let attendanceData = [];

        // Function to show different pages
        function showPage(pageId) {
            // Hide all pages
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            
            // Remove active class from all buttons
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });
            
            // Show selected page and activate button
            document.getElementById(pageId).classList.add('active');
            event.target.classList.add('active');
        }

        // Function to load CSV data with CORS handling for Google Sheets
        async function loadCSVData(url, callback, dataType) {
            try {
                console.log(`Loading ${dataType} data from:`, url);
                
                // Try direct fetch first
                let response;
                let csvText;
                
                try {
                    response = await fetch(url);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    csvText = await response.text();
                } catch (fetchError) {
                    console.log(`Direct fetch failed for ${dataType}, trying CORS proxy...`);
                    
                    // Try with CORS proxy
                    const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(url)}`;
                    const proxyResponse = await fetch(proxyUrl);
                    
                    if (!proxyResponse.ok) {
                        throw new Error(`Proxy error! status: ${proxyResponse.status}`);
                    }
                    
                    const proxyData = await proxyResponse.json();
                    csvText = proxyData.contents;
                }
                
                console.log(`${dataType} CSV data loaded, length:`, csvText.length);
                
                Papa.parse(csvText, {
                    header: true,
                    dynamicTyping: true,
                    skipEmptyLines: true,
                    transformHeader: function(header) {
                        // Clean up headers by removing extra spaces and converting to lowercase
                        return header.trim().toLowerCase().replace(/\s+/g, '_');
                    },
                    complete: function(results) {
                        console.log(`${dataType} raw parsed data:`, results.data);
                        console.log(`${dataType} data columns:`, results.data.length > 0 ? Object.keys(results.data[0]) : 'No data');
                        
                        // Process the data based on type
                        let processedData = results.data;
                        
                        if (dataType === 'Performance') {
                            processedData = processPerformanceData(results.data);
                        } else if (dataType === 'Attendance') {
                            processedData = processAttendanceData(results.data);
                        }
                        
                        console.log(`${dataType} processed data:`, processedData);
                        callback({ data: processedData });
                    },
                    error: function(error) {
                        console.error(`Error parsing ${dataType} CSV:`, error);
                        throw error;
                    }
                });
            } catch (error) {
                console.error(`Error loading ${dataType} CSV:`, error);
                
                // Show error message to user
                showErrorMessage(dataType, error);
                
                // Use sample data if CSV loading fails
                console.log(`Using sample data for ${dataType}`);
                if (dataType === 'Performance') {
                    callback({ data: samplePerformanceData });
                } else {
                    callback({ data: sampleAttendanceData });
                }
            }
        }

        // Function to show error messages
        function showErrorMessage(dataType, error) {
            const existingError = document.querySelector(`.error-${dataType.toLowerCase()}`);
            if (existingError) existingError.remove();
            
            const errorDiv = document.createElement('div');
            errorDiv.className = `error error-${dataType.toLowerCase()}`;
            errorDiv.innerHTML = `
                <h3>‚ö†Ô∏è ${dataType} Data Loading Issue</h3>
                <p><strong>Error:</strong> ${error.message}</p>
                <p>This is likely due to CORS restrictions. The dashboard is now using sample data.</p>
                <details style="margin-top: 1rem;">
                    <summary style="cursor: pointer; font-weight: 600;">üîß Technical Solutions</summary>
                    <div style="margin-top: 0.5rem; font-size: 0.9rem;">
                        <p><strong>Option 1:</strong> Make your Google Sheet public:</p>
                        <ol style="text-align: left; margin: 0.5rem 0;">
                            <li>Open your Google Sheet</li>
                            <li>Click Share ‚Üí Change to "Anyone with the link"</li>
                            <li>Set permission to "Viewer"</li>
                        </ol>
                        <p><strong>Option 2:</strong> Deploy to a web server (GitHub Pages, Netlify, etc.) which often resolves CORS issues.</p>
                        <p><strong>Option 3:</strong> The dashboard will automatically retry in 5 minutes.</p>
                    </div>
                </details>
                <button onclick="this.parentElement.remove()" style="
                    background: white;
                    color: #e74c3c;
                    border: none;
                    padding: 0.5rem 1rem;
                    border-radius: 5px;
                    cursor: pointer;
                    font-weight: 600;
                    margin-top: 1rem;
                ">‚úñÔ∏è Close</button>
            `;
            
            // Insert after the appropriate section header
            const targetSection = dataType === 'Performance' ? 
                document.getElementById('performance') : 
                document.getElementById('attendance');
            
            if (targetSection) {
                const sectionHeader = targetSection.querySelector('.section-header');
                if (sectionHeader) {
                    sectionHeader.insertAdjacentElement('afterend', errorDiv);
                }
            }
        }

        // Process performance data to handle various column name formats
        function processPerformanceData(rawData) {
            console.log('Processing performance data:', rawData);
            
            if (!rawData || rawData.length === 0) {
                console.warn('No performance data to process');
                return samplePerformanceData;
            }
            
            return rawData.map(row => {
                console.log('Processing performance row:', row);
                const processed = {};
                
                // Handle different possible column names for supervisor
                processed.supervisor = row.supervisor || row.name || row.supervisor_name || 
                                     row.employee_name || row.employee || row.staff_name || 
                                     'Unknown Supervisor';
                
                // Handle productivity rate (convert percentages if needed)
                let prodRate = parseFloat(row.productivity_rate || row.productivity || 
                                        row.performance_rate || row.efficiency_rate || 0);
                processed.productivity_rate = prodRate > 1 ? prodRate : prodRate * 100;
                
                // Handle tasks completed
                processed.tasks_completed = parseInt(row.tasks_completed || row.tasks || 
                                                   row.completed_tasks || row.total_tasks || 0);
                
                // Handle efficiency score
                let effScore = parseFloat(row.efficiency_score || row.efficiency || 
                                        row.score || row.rating || 0);
                processed.efficiency_score = effScore > 1 ? effScore : effScore * 100;
                
                // Handle target achievement
                let targetAch = parseFloat(row.target_achievement || row.target || 
                                         row.achievement || row.goal_completion || 0);
                processed.target_achievement = targetAch > 1 ? targetAch : targetAch * 100;
                
                console.log('Processed performance row:', processed);
                return processed;
            }).filter(row => row.supervisor !== 'Unknown Supervisor' && 
                           !isNaN(row.productivity_rate)); // Filter out invalid rows
        }

        // Process attendance data to handle various column name formats
        function processAttendanceData(rawData) {
            console.log('Processing attendance data:', rawData);
            
            if (!rawData || rawData.length === 0) {
                console.warn('No attendance data to process');
                return sampleAttendanceData;
            }
            
            return rawData.map(row => {
                console.log('Processing attendance row:', row);
                const processed = {};
                
                // Handle different possible column names for worker
                processed.worker = row.worker || row.employee || row.name || 
                                 row.employee_name || row.staff_name || row.person || 
                                 'Unknown Worker';
                
                // Handle date formats
                let dateValue = row.date || row.work_date || row.attendance_date || 
                               row.day || row.shift_date;
                               
                if (dateValue) {
                    // Try to parse different date formats
                    if (typeof dateValue === 'string') {
                        // Handle various date formats
                        const parsedDate = new Date(dateValue);
                        if (!isNaN(parsedDate.getTime())) {
                            processed.date = parsedDate.toISOString().split('T')[0]; // YYYY-MM-DD format
                        } else {
                            // Try different date format parsing
                            const parts = dateValue.split(/[-/]/);
                            if (parts.length === 3) {
                                // Assume MM/DD/YYYY or DD/MM/YYYY format
                                const testDate = new Date(parts[2], parts[0] - 1, parts[1]);
                                if (!isNaN(testDate.getTime())) {
                                    processed.date = testDate.toISOString().split('T')[0];
                                } else {
                                    processed.date = dateValue;
                                }
                            } else {
                                processed.date = dateValue;
                            }
                        }
                    } else if (typeof dateValue === 'number') {
                        // Handle Excel date numbers
                        const excelDate = new Date((dateValue - 25569) * 86400 * 1000);
                        processed.date = excelDate.toISOString().split('T')[0];
                    }
                } else {
                    processed.date = new Date().toISOString().split('T')[0]; // Default to today
                }
                
                // Handle hours worked
                processed.hours_worked = parseFloat(row.hours_worked || row.hours || 
                                                  row.work_hours || row.total_hours || 
                                                  row.duration || 0);
                
                console.log('Processed attendance row:', processed);
                return processed;
            }).filter(row => row.worker !== 'Unknown Worker' && 
                           row.hours_worked > 0); // Filter out invalid rows
        }

        // Generate AI suggestions based on performance data
        function generatePerformanceAI(data) {
            const avgProductivity = data.reduce((sum, item) => sum + item.productivity_rate, 0) / data.length;
            const bestPerformer = data.reduce((best, current) => 
                current.productivity_rate > best.productivity_rate ? current : best
            );
            const needsImprovement = data.filter(item => item.productivity_rate < 80);

            let suggestion = `Site average productivity is ${avgProductivity.toFixed(1)}%. `;
            
            if (avgProductivity > 85) {
                suggestion += `Excellent performance across the board! Consider implementing ${bestPerformer.supervisor}'s best practices site-wide.`;
            } else if (needsImprovement.length > 0) {
                suggestion += `${needsImprovement.length} supervisor(s) need support. Focus on training and resource allocation for ${needsImprovement.map(s => s.supervisor).join(', ')}.`;
            } else {
                suggestion += `Good overall performance. Consider setting stretch goals to drive further improvement.`;
            }

            return suggestion;
        }

        // Generate AI suggestions for individual supervisors
        function generateSupervisorAI(supervisor) {
            if (supervisor.productivity_rate >= 90) {
                return `Outstanding performance! Consider mentoring other supervisors and taking on advanced projects.`;
            } else if (supervisor.productivity_rate >= 80) {
                return `Good performance. Focus on efficiency improvements to reach the 90%+ tier.`;
            } else {
                return `Performance needs improvement. Recommend additional training and close monitoring of task completion rates.`;
            }
        }

        // Render performance dashboard
        function renderPerformance(data) {
            performanceData = data;
            
            // Calculate overall stats
            const avgProductivity = data.reduce((sum, item) => sum + item.productivity_rate, 0) / data.length;
            const totalTasks = data.reduce((sum, item) => sum + item.tasks_completed, 0);
            const avgEfficiency = data.reduce((sum, item) => sum + item.efficiency_score, 0) / data.length;
            const avgTargetAchievement = data.reduce((sum, item) => sum + item.target_achievement, 0) / data.length;

            // Render overall stats
            document.getElementById('overall-stats').innerHTML = `
                <div class="stat-card">
                    <div class="stat-number">${avgProductivity.toFixed(1)}%</div>
                    <div class="stat-label">Avg Productivity</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${totalTasks}</div>
                    <div class="stat-label">Total Tasks</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${avgEfficiency.toFixed(1)}%</div>
                    <div class="stat-label">Avg Efficiency</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${avgTargetAchievement.toFixed(1)}%</div>
                    <div class="stat-label">Target Achievement</div>
                </div>
            `;

            // Render site AI suggestion
            document.getElementById('site-ai-suggestion').innerHTML = `
                <div class="ai-suggestion">
                    ${generatePerformanceAI(data)}
                </div>
            `;

            // Render supervisor cards
            const performanceCards = data.map(supervisor => `
                <div class="card">
                    <div class="card-title">
                        üë®‚Äçüíº ${supervisor.supervisor}
                    </div>
                    <div class="metric">
                        <span class="metric-label">Productivity Rate</span>
                        <span class="metric-value">${supervisor.productivity_rate}%</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Tasks Completed</span>
                        <span class="metric-value">${supervisor.tasks_completed}</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Efficiency Score</span>
                        <span class="metric-value">${supervisor.efficiency_score}%</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Target Achievement</span>
                        <span class="metric-value">${supervisor.target_achievement}%</span>
                    </div>
                    <div class="ai-suggestion">
                        ${generateSupervisorAI(supervisor)}
                    </div>
                </div>
            `).join('');

            document.getElementById('performance-cards').innerHTML = performanceCards;
        }

        // Generate attendance AI suggestions
        function generateAttendanceAI(attendanceData) {
            const workers = [...new Set(attendanceData.map(record => record.worker))];
            const totalRecords = attendanceData.length;
            const overtimeRecords = attendanceData.filter(record => record.hours_worked > 8).length;
            const overtimeRate = ((overtimeRecords / totalRecords) * 100).toFixed(1);

            let suggestion = `Tracking ${workers.length} workers with ${totalRecords} attendance records. `;
            
            if (overtimeRate > 30) {
                suggestion += `High overtime rate (${overtimeRate}%). Consider hiring additional staff or redistributing workload to prevent burnout.`;
            } else if (overtimeRate > 15) {
                suggestion += `Moderate overtime detected (${overtimeRate}%). Monitor workload distribution and consider capacity planning.`;
            } else {
                suggestion += `Healthy work-life balance maintained with ${overtimeRate}% overtime rate. Continue current staffing levels.`;
            }

            return suggestion;
        }

        // Enhanced attendance rendering with better date handling
        function renderAttendance(data) {
            attendanceData = data;
            
            // Render attendance AI suggestion
            document.getElementById('attendance-ai-suggestion').innerHTML = `
                <div class="ai-suggestion">
                    ${generateAttendanceAI(data)}
                </div>
            `;

            // Group data by worker
            const workerData = {};
            data.forEach(record => {
                if (!workerData[record.worker]) {
                    workerData[record.worker] = [];
                }
                workerData[record.worker].push(record);
            });

            // Get current date information
            const now = new Date();
            const currentMonth = now.getMonth() + 1; // JavaScript months are 0-indexed
            const currentYear = now.getFullYear();
            const daysInMonth = new Date(currentYear, currentMonth, 0).getDate();
            const firstDayOfMonth = new Date(currentYear, currentMonth - 1, 1).getDay();
            
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                'July', 'August', 'September', 'October', 'November', 'December'];
            
            const attendanceCards = Object.keys(workerData).map(worker => {
                const workerRecords = workerData[worker];
                
                // Create calendar with proper first day alignment
                let calendar = `
                    <div style="text-align: center; margin-bottom: 1rem; font-weight: 600; color: #2c3e50;">
                        ${monthNames[currentMonth - 1]} ${currentYear}
                    </div>
                    <div class="calendar">
                        <div class="calendar-day calendar-header">Sun</div>
                        <div class="calendar-day calendar-header">Mon</div>
                        <div class="calendar-day calendar-header">Tue</div>
                        <div class="calendar-day calendar-header">Wed</div>
                        <div class="calendar-day calendar-header">Thu</div>
                        <div class="calendar-day calendar-header">Fri</div>
                        <div class="calendar-day calendar-header">Sat</div>
                `;

                // Add empty cells for days before the first day of the month
                for (let i = 0; i < firstDayOfMonth; i++) {
                    calendar += '<div class="calendar-day"></div>';
                }

                // Add days of the month
                for (let day = 1; day <= daysInMonth; day++) {
                    const dateStr = `${currentYear}-${currentMonth.toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}`;
                    const dayRecord = workerRecords.find(record => {
                        // Try to match dates in various formats
                        const recordDate = record.date;
                        return recordDate === dateStr || 
                               recordDate === `${currentMonth}/${day}/${currentYear}` ||
                               recordDate === `${day}/${currentMonth}/${currentYear}` ||
                               new Date(recordDate).toISOString().split('T')[0] === dateStr;
                    });
                    
                    let dayClass = 'calendar-date absent';
                    let title = `${worker} - ${dateStr}: Absent`;
                    
                    if (dayRecord && dayRecord.hours_worked > 0) {
                        if (dayRecord.hours_worked >= 8) {
                            dayClass = dayRecord.hours_worked > 8 ? 'calendar-date present overtime' : 'calendar-date present';
                            title = `${worker} - ${dateStr}: Present (${dayRecord.hours_worked}h)`;
                            if (dayRecord.hours_worked > 8) {
                                title += ` - Overtime: ${(dayRecord.hours_worked - 8).toFixed(1)}h`;
                            }
                        } else {
                            dayClass = 'calendar-date present';
                            title = `${worker} - ${dateStr}: Present (${dayRecord.hours_worked}h - Partial Day)`;
                        }
                    }
                    
                    calendar += `<div class="${dayClass}" title="${title}">${day}</div>`;
                }
                
                calendar += '</div>';

                // Calculate comprehensive stats
                const presentDays = workerRecords.filter(record => record.hours_worked > 0).length;
                const fullDays = workerRecords.filter(record => record.hours_worked >= 8).length;
                const overtimeDays = workerRecords.filter(record => record.hours_worked > 8).length;
                const totalHours = workerRecords.reduce((sum, record) => sum + record.hours_worked, 0);
                const totalOvertime = workerRecords.reduce((sum, record) => 
                    sum + Math.max(0, record.hours_worked - 8), 0
                ).toFixed(1);
                const avgHoursPerDay = presentDays > 0 ? (totalHours / presentDays).toFixed(1) : 0;

                return `
                    <div class="card">
                        <div class="card-title">
                            üë§ ${worker}
                        </div>
                        ${calendar}
                        <div class="status-legend">
                            <div class="legend-item">
                                <div class="legend-color present"></div>
                                <span>Present</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color absent"></div>
                                <span>Absent</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color overtime"></div>
                                <span>Overtime</span>
                            </div>
                        </div>
                        <div class="metric">
                            <span class="metric-label">Days Worked</span>
                            <span class="metric-value">${presentDays}</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">Full Days (8+h)</span>
                            <span class="metric-value">${fullDays}</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">Overtime Days</span>
                            <span class="metric-value">${overtimeDays}</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">Total Hours</span>
                            <span class="metric-value">${totalHours.toFixed(1)}h</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">Total Overtime</span>
                            <span class="metric-value">${totalOvertime}h</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">Avg Hours/Day</span>
                            <span class="metric-value">${avgHoursPerDay}h</span>
                        </div>
                    </div>
                `;
            }).join('');

            document.getElementById('attendance-cards').innerHTML = attendanceCards;
        }

        // Initialize dashboard with better error handling
        async function initDashboard() {
            // Show loading indicator
            const existingLoading = document.querySelector('.loading');
            if (existingLoading) existingLoading.remove();
            
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'loading';
            loadingDiv.innerHTML = 'üîÑ Loading dashboard data from Google Sheets...';
            document.body.appendChild(loadingDiv);
            
            try {
                // Load performance data
                await new Promise(resolve => {
                    loadCSVData(PERFORMANCE_CSV_URL, (results) => {
                        console.log('Performance data loaded:', results.data);
                        renderPerformance(results.data);
                        resolve();
                    }, 'Performance');
                });

                // Load attendance data
                await new Promise(resolve => {
                    loadCSVData(ATTENDANCE_CSV_URL, (results) => {
                        console.log('Attendance data loaded:', results.data);
                        renderAttendance(results.data);
                        resolve();
                    }, 'Attendance');
                });

                // Remove loading indicator
                const loading = document.querySelector('.loading');
                if (loading) loading.remove();

                // Show success message
                const successDiv = document.createElement('div');
                successDiv.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: #2ecc71;
                    color: white;
                    padding: 1rem;
                    border-radius: 10px;
                    z-index: 1000;
                    font-weight: 600;
                `;
                successDiv.innerHTML = '‚úÖ Dashboard data loaded successfully!';
                document.body.appendChild(successDiv);
                
                setTimeout(() => {
                    if (successDiv.parentNode) {
                        successDiv.parentNode.removeChild(successDiv);
                    }
                }, 3000);

                // Set up auto-refresh every 5 minutes
                setTimeout(() => {
                    console.log('Auto-refreshing dashboard data...');
                    initDashboard();
                }, 300000); // 5 minutes

            } catch (error) {
                console.error('Dashboard initialization error:', error);
                const loading = document.querySelector('.loading');
                if (loading) loading.remove();
                
                const errorDiv = document.createElement('div');
                errorDiv.className = 'error';
                errorDiv.innerHTML = `
                    <h3>‚ùå Dashboard Initialization Error</h3>
                    <p>There was an issue loading the dashboard. Please check:</p>
                    <ul style="text-align: left; margin: 1rem 0;">
                        <li>Internet connection</li>
                        <li>Google Sheets permissions</li>
                        <li>CSV link accessibility</li>
                    </ul>
                    <button onclick="location.reload()" style="
                        background: white;
                        color: #e74c3c;
                        border: none;
                        padding: 0.5rem 1rem;
                        border-radius: 5px;
                        cursor: pointer;
                        font-weight: 600;
                        margin-top: 1rem;
                    ">üîÑ Retry</button>
                `;
                document.body.appendChild(errorDiv);
            }
        }

        // Start the dashboard
        initDashboard();
    </script>
</body>
</html>

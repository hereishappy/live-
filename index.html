<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Site Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        /* ---------- Base Styles ---------- */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
               background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
               min-height: 100vh; color: #333; }
        .container { max-width: 1200px; margin: 0 auto; padding: 1rem; }
        .header { text-align: center; margin-bottom: 2rem; color: white; }
        .header h1 { font-size: 2.5rem; margin-bottom: 0.5rem; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); }

        /* ---------- Tabs ---------- */
        .nav-tabs { display: flex; justify-content: center; gap: 1rem; margin-bottom: 2rem; flex-wrap: wrap; }
        .tab-button { padding: 12px 24px; background: rgba(255,255,255,0.2);
                      border: 2px solid rgba(255,255,255,0.3); border-radius: 25px;
                      color: white; cursor: pointer; transition: all 0.3s ease;
                      backdrop-filter: blur(10px); font-weight: 600; }
        .tab-button.active { background: rgba(255,255,255,0.9); color: #333;
                             transform: translateY(-2px); box-shadow: 0 8px 16px rgba(0,0,0,0.2); }
        .page { display: none; }
        .page.active { display: block; }

        /* ---------- Cards & Sections ---------- */
        .section-header { background: rgba(255,255,255,0.95); padding: 1.5rem; border-radius: 15px;
                          margin-bottom: 2rem; text-align: center; box-shadow: 0 8px 32px rgba(0,0,0,0.1); }
        .section-header h2 { color: #2c3e50; font-size: 1.8rem; margin-bottom: 0.5rem; }
        .cards-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
                      gap: 1.5rem; margin-bottom: 2rem; }
        .card { background: rgba(255,255,255,0.95); border-radius: 20px; padding: 1.5rem;
                box-shadow: 0 10px 30px rgba(0,0,0,0.1); backdrop-filter: blur(10px);
                border: 1px solid rgba(255,255,255,0.2); transition: transform 0.3s ease, box-shadow 0.3s ease; }
        .card:hover { transform: translateY(-5px); box-shadow: 0 15px 40px rgba(0,0,0,0.15); }
        .card-title { font-size: 1.3rem; font-weight: 700; color: #2c3e50; margin-bottom: 1rem;
                      display: flex; align-items: center; gap: 0.5rem; }
        .metric { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.8rem;
                  padding: 0.5rem; background: rgba(74, 144, 226, 0.1); border-radius: 10px; }
        .metric-label { font-weight: 600; color: #34495e; }
        .metric-value { font-weight: 700; color: #2980b9; font-size: 1.1rem; }

        /* ---------- AI Suggestion ---------- */
        .ai-suggestion { background: linear-gradient(135deg, #667eea, #764ba2); color: white;
                         padding: 1rem; border-radius: 12px; margin-top: 1rem; font-size: 0.9rem; line-height: 1.5; }
        .ai-suggestion::before { content: "ü§ñ AI Suggestion: "; font-weight: 700; }

        /* ---------- Stats ---------- */
        .overall-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                         gap: 1rem; margin-bottom: 2rem; }
        .stat-card { background: rgba(255,255,255,0.9); padding: 1.5rem; border-radius: 15px;
                     text-align: center; box-shadow: 0 5px 20px rgba(0,0,0,0.1); }
        .stat-number { font-size: 2rem; font-weight: 700; color: #2980b9; }
        .stat-label { font-size: 0.9rem; color: #7f8c8d; margin-top: 0.5rem; }

        /* ---------- Responsive ---------- */
        @media (max-width: 768px) {
            .container { padding: 0.5rem; }
            .header h1 { font-size: 2rem; }
            .nav-tabs { flex-direction: column; align-items: center; }
            .cards-grid { grid-template-columns: 1fr; }
            .overall-stats { grid-template-columns: repeat(2, 1fr); }
        }

        /* ---------- Alerts ---------- */
        .loading { text-align: center; color: white; font-size: 1.2rem; padding: 2rem; }
        .error { background: #e74c3c; color: white; padding: 1rem; border-radius: 10px;
                 margin: 1rem 0; text-align: center; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä Site Dashboard</h1>
            <p>Real-time Performance & Attendance Analytics</p>
        </div>

        <div class="nav-tabs">
            <button class="tab-button active" onclick="showPage('performance', this)">üìà Performance</button>
            <button class="tab-button" onclick="showPage('attendance', this)">üìÖ Attendance</button>
        </div>

        <!-- Performance Page -->
        <div id="performance" class="page active">
            <div class="section-header">
                <h2>üéØ Overall Site Performance</h2>
                <p>Comprehensive site analytics and AI-powered insights</p>
            </div>
            <div id="overall-stats" class="overall-stats"></div>
            <div id="site-ai-suggestion" class="card"></div>
            <div id="performance-cards" class="cards-grid"></div>
        </div>

        <!-- Attendance Page -->
        <div id="attendance" class="page">
            <div class="section-header">
                <h2>üìÖ Site Attendance & AI Suggestions</h2>
                <p>Worker attendance tracking with smart analytics</p>
            </div>
            <div id="attendance-ai-suggestion" class="card"></div>
            <div id="attendance-cards" class="cards-grid"></div>
        </div>
    </div>

    <script>
        const PERFORMANCE_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTRmYg3zmYTdR76pDZirRk3Q-jGChOHtKwW5sRhi9NmaOWjCCvMeGi_CzmtbEVRrVt_u4mgTQmyrjYB/pub?gid=1486071949&single=true&output=csv';
        const ATTENDANCE_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTRmYg3zmYTdR76pDZirRk3Q-jGChOHtKwW5sRhi9NmaOWjCCvMeGi_CzmtbEVRrVt_u4mgTQmyrjYB/pub?gid=1025965600&single=true&output=csv';

        function showPage(pageId, el) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            if (el) el.classList.add('active');
        }

        async function loadCSVData(url, callback, dataType) {
            try {
                const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(url)}`;
                const response = await fetch(proxyUrl);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const proxyData = await response.json();
                const csvText = proxyData.contents;

                Papa.parse(csvText, {
                    header: true,
                    dynamicTyping: true,
                    skipEmptyLines: true,
                    transformHeader: h => h.trim().toLowerCase().replace(/\s+/g, '_'),
                    complete: results => callback({ data: results.data }),
                    error: err => { throw err; }
                });
            } catch (error) {
                console.error(`Error loading ${dataType} CSV:`, error);
                document.getElementById(`${dataType.toLowerCase()}-ai-suggestion`).innerHTML =
                    `<div class="ai-suggestion">‚ö†Ô∏è Failed to load ${dataType} data.</div>`;
            }
        }

        function renderPerformance(data) {
            const avgProd = data.reduce((s, d) => s + d.productivity_rate, 0) / data.length;
            const totalTasks = data.reduce((s, d) => s + d.tasks_completed, 0);
            const avgEff = data.reduce((s, d) => s + d.efficiency_score, 0) / data.length;
            const avgTarget = data.reduce((s, d) => s + d.target_achievement, 0) / data.length;

            document.getElementById('overall-stats').innerHTML = `
                <div class="stat-card"><div class="stat-number">${avgProd.toFixed(1)}%</div><div class="stat-label">Avg Productivity</div></div>
                <div class="stat-card"><div class="stat-number">${totalTasks}</div><div class="stat-label">Total Tasks</div></div>
                <div class="stat-card"><div class="stat-number">${avgEff.toFixed(1)}%</div><div class="stat-label">Avg Efficiency</div></div>
                <div class="stat-card"><div class="stat-number">${avgTarget.toFixed(1)}%</div><div class="stat-label">Target Achievement</div></div>
            `;

            document.getElementById('site-ai-suggestion').innerHTML =
                `<div class="ai-suggestion">Site average productivity is ${avgProd.toFixed(1)}%.</div>`;

            document.getElementById('performance-cards').innerHTML = data.map(sup => `
                <div class="card">
                    <div class="card-title">üë®‚Äçüíº ${sup.supervisor}</div>
                    <div class="metric"><span class="metric-label">Productivity Rate</span><span class="metric-value">${sup.productivity_rate}%</span></div>
                    <div class="metric"><span class="metric-label">Tasks Completed</span><span class="metric-value">${sup.tasks_completed}</span></div>
                    <div class="metric"><span class="metric-label">Efficiency Score</span><span class="metric-value">${sup.efficiency_score}%</span></div>
                    <div class="metric"><span class="metric-label">Target Achievement</span><span class="metric-value">${sup.target_achievement}%</span></div>
                </div>
            `).join('');
        }

        function renderAttendance(data) {
            document.getElementById('attendance-ai-suggestion').innerHTML =
                `<div class="ai-suggestion">Tracking ${data.length} attendance records.</div>`;

            document.getElementById('attendance-cards').innerHTML = data.map(rec => `
                <div class="card">
                    <div class="card-title">üë§ ${rec.worker}</div>
                    <div class="metric"><span class="metric-label">Date</span><span class="metric-value">${rec.date}</span></div>
                    <div class="metric"><span class="metric-label">Hours Worked</span><span class="metric-value">${rec.hours_worked}</span></div>
                </div>
            `).join('');
        }

        function initDashboard() {
            loadCSVData(PERFORMANCE_CSV_URL, results => renderPerformance(results.data), 'Performance');
            loadCSVData(ATTENDANCE_CSV_URL, results => renderAttendance(results.data), 'Attendance');
        }

        initDashboard();
    </script>
</body>
</html>
